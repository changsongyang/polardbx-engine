call mtr.add_suppression('Unsafe statement written .*');
call mtr.add_suppression('Found .*');
create database db_crash_9;
create table db_crash_9.t(id int);
insert into db_crash_9.t values(0);
create table db_crash_9.t2(id int);
insert into db_crash_9.t2 values(0);
# run cmd: insert into db_crash_9.t values(1)
xa recover;
formatID	gtrid_length	bqual_length	data
# 01. succ
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000001	2795	1
binlog.000002	292	9
xa recover;
formatID	gtrid_length	bqual_length	data
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000001	2795	1
binlog.000002	3486	9
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
finish load
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000001	2795	1
binlog.000002	3530	9
binlog.000003	292	17
insert into db_crash_9.t2 values(1);
call dbms_consensus.purge_log(17);;
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000003	662	17
xa commit 'xx';
# 11. crash_purge_before_update_index
set @@debug='';
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000003	1049	17
binlog.000004	292	20
xa recover;
formatID	gtrid_length	bqual_length	data
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000003	1049	17
binlog.000004	3486	20
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
finish load
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000003	1049	17
binlog.000004	3530	20
binlog.000005	292	28
insert into db_crash_9.t2 values(1);
select @@debug;
@@debug

call dbms_consensus.purge_log(28);;
show consensus logs;
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000003	1049	17
binlog.000004	3530	20
binlog.000005	744	28
xa commit 'xx';
# 21. crash_purge_before_remove_logs_from_index
set @@debug='';
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000003	1049	17
binlog.000004	3530	20
binlog.000005	1131	28
binlog.000006	292	32
xa recover;
formatID	gtrid_length	bqual_length	data
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000003	1049	17
binlog.000004	3530	20
binlog.000005	1131	28
binlog.000006	3486	32
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
finish load
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000003	1049	17
binlog.000004	3530	20
binlog.000005	1131	28
binlog.000006	3530	32
binlog.000007	292	40
insert into db_crash_9.t2 values(1);
select @@debug;
@@debug

call dbms_consensus.purge_log(40);;
show consensus logs;
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000003	1049	17
binlog.000004	3530	20
binlog.000005	1131	28
binlog.000006	3530	32
binlog.000007	744	40
xa commit 'xx';
# 41. crash_create_before_rename_index_file
set @@debug='';
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000003	1049	17
binlog.000004	3530	20
binlog.000005	1131	28
binlog.000006	3530	32
binlog.000007	1131	40
binlog.000008	292	44
xa recover;
formatID	gtrid_length	bqual_length	data
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000003	1049	17
binlog.000004	3530	20
binlog.000005	1131	28
binlog.000006	3530	32
binlog.000007	1131	40
binlog.000008	3486	44
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
finish load
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000003	1049	17
binlog.000004	3530	20
binlog.000005	1131	28
binlog.000006	3530	32
binlog.000007	1131	40
binlog.000008	3530	44
binlog.000009	292	52
insert into db_crash_9.t2 values(1);
select @@debug;
@@debug

call dbms_consensus.purge_log(52);;
show consensus logs;
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000009	744	52
xa commit 'xx';
# 51. crash_create_after_rename_index_file
set @@debug='';
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000009	1131	52
binlog.000010	292	56
xa recover;
formatID	gtrid_length	bqual_length	data
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000009	1131	52
binlog.000010	3486	56
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
finish load
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000009	1131	52
binlog.000010	3530	56
binlog.000011	292	64
insert into db_crash_9.t2 values(1);
select @@debug;
@@debug

call dbms_consensus.purge_log(64);;
show consensus logs;
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000011	744	64
xa commit 'xx';
# 61. crash_purge_before_truncate_before
set @@debug='';
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000011	1131	64
binlog.000012	292	68
xa recover;
formatID	gtrid_length	bqual_length	data
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000011	1131	64
binlog.000012	3486	68
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
finish load
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000011	1131	64
binlog.000012	3530	68
binlog.000013	292	76
insert into db_crash_9.t2 values(1);
select @@debug;
@@debug

call dbms_consensus.purge_log(76);;
show consensus logs;
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000013	744	76
xa commit 'xx';
# 71. crash_purge_before_update_index_after_truncate
set @@debug='';
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000013	1131	76
binlog.000014	292	80
xa recover;
formatID	gtrid_length	bqual_length	data
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000013	1131	76
binlog.000014	3486	80
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
finish load
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000013	1131	76
binlog.000014	3530	80
binlog.000015	292	88
insert into db_crash_9.t2 values(1);
select @@debug;
@@debug

call dbms_consensus.purge_log(88);;
show consensus logs;
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000015	744	88
xa commit 'xx';
# 81. crash_purge_critical_after_update_index
set @@debug='';
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000015	1131	88
binlog.000016	292	92
xa recover;
formatID	gtrid_length	bqual_length	data
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000015	1131	88
binlog.000016	3486	92
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
finish load
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000015	1131	88
binlog.000016	3530	92
binlog.000017	292	100
insert into db_crash_9.t2 values(1);
select @@debug;
@@debug

call dbms_consensus.purge_log(100);;
show consensus logs;
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000017	744	100
xa commit 'xx';
# 91. crash_purge_non_critical_after_update_index
set @@debug='';
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000017	1131	100
binlog.000018	292	104
xa recover;
formatID	gtrid_length	bqual_length	data
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000017	1131	100
binlog.000018	3486	104
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
finish load
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000017	1131	100
binlog.000018	3530	104
binlog.000019	292	112
insert into db_crash_9.t2 values(1);
select @@debug;
@@debug

call dbms_consensus.purge_log(112);;
show consensus logs;
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000019	744	112
xa commit 'xx';
# run cmd: update db_crash_9.t set id = id+1
xa recover;
formatID	gtrid_length	bqual_length	data
# 02. succ
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000019	1049	112
binlog.000020	292	115
xa recover;
formatID	gtrid_length	bqual_length	data
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000019	1049	112
binlog.000020	6276	115
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
finish load
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000019	1049	112
binlog.000020	6320	115
binlog.000021	292	123
insert into db_crash_9.t2 values(1);
call dbms_consensus.purge_log(123);;
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000021	662	123
xa commit 'xx';
# 12. crash_purge_before_update_index
set @@debug='';
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000021	1049	123
binlog.000022	292	126
xa recover;
formatID	gtrid_length	bqual_length	data
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000021	1049	123
binlog.000022	6276	126
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
finish load
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000021	1049	123
binlog.000022	6320	126
binlog.000023	292	134
insert into db_crash_9.t2 values(1);
select @@debug;
@@debug

call dbms_consensus.purge_log(134);;
show consensus logs;
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000021	1049	123
binlog.000022	6320	126
binlog.000023	744	134
xa commit 'xx';
# 22. crash_purge_before_remove_logs_from_index
set @@debug='';
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000021	1049	123
binlog.000022	6320	126
binlog.000023	1131	134
binlog.000024	292	138
xa recover;
formatID	gtrid_length	bqual_length	data
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000021	1049	123
binlog.000022	6320	126
binlog.000023	1131	134
binlog.000024	6276	138
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
finish load
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000021	1049	123
binlog.000022	6320	126
binlog.000023	1131	134
binlog.000024	6320	138
binlog.000025	292	146
insert into db_crash_9.t2 values(1);
select @@debug;
@@debug

call dbms_consensus.purge_log(146);;
show consensus logs;
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000021	1049	123
binlog.000022	6320	126
binlog.000023	1131	134
binlog.000024	6320	138
binlog.000025	744	146
xa commit 'xx';
# 42. crash_create_before_rename_index_file
set @@debug='';
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000021	1049	123
binlog.000022	6320	126
binlog.000023	1131	134
binlog.000024	6320	138
binlog.000025	1131	146
binlog.000026	292	150
xa recover;
formatID	gtrid_length	bqual_length	data
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000021	1049	123
binlog.000022	6320	126
binlog.000023	1131	134
binlog.000024	6320	138
binlog.000025	1131	146
binlog.000026	6276	150
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
finish load
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000021	1049	123
binlog.000022	6320	126
binlog.000023	1131	134
binlog.000024	6320	138
binlog.000025	1131	146
binlog.000026	6320	150
binlog.000027	292	158
insert into db_crash_9.t2 values(1);
select @@debug;
@@debug

call dbms_consensus.purge_log(158);;
show consensus logs;
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000027	744	158
xa commit 'xx';
# 52. crash_create_after_rename_index_file
set @@debug='';
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000027	1131	158
binlog.000028	292	162
xa recover;
formatID	gtrid_length	bqual_length	data
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000027	1131	158
binlog.000028	6276	162
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
finish load
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000027	1131	158
binlog.000028	6320	162
binlog.000029	292	170
insert into db_crash_9.t2 values(1);
select @@debug;
@@debug

call dbms_consensus.purge_log(170);;
show consensus logs;
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000029	744	170
xa commit 'xx';
# 62. crash_purge_before_truncate_before
set @@debug='';
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000029	1131	170
binlog.000030	292	174
xa recover;
formatID	gtrid_length	bqual_length	data
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000029	1131	170
binlog.000030	6276	174
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
finish load
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000029	1131	170
binlog.000030	6320	174
binlog.000031	292	182
insert into db_crash_9.t2 values(1);
select @@debug;
@@debug

call dbms_consensus.purge_log(182);;
show consensus logs;
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000031	744	182
xa commit 'xx';
# 72. crash_purge_before_update_index_after_truncate
set @@debug='';
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000031	1131	182
binlog.000032	292	186
xa recover;
formatID	gtrid_length	bqual_length	data
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000031	1131	182
binlog.000032	6276	186
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
finish load
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000031	1131	182
binlog.000032	6320	186
binlog.000033	292	194
insert into db_crash_9.t2 values(1);
select @@debug;
@@debug

call dbms_consensus.purge_log(194);;
show consensus logs;
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000033	744	194
xa commit 'xx';
# 82. crash_purge_critical_after_update_index
set @@debug='';
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000033	1131	194
binlog.000034	292	198
xa recover;
formatID	gtrid_length	bqual_length	data
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000033	1131	194
binlog.000034	6276	198
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
finish load
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000033	1131	194
binlog.000034	6320	198
binlog.000035	292	206
insert into db_crash_9.t2 values(1);
select @@debug;
@@debug

call dbms_consensus.purge_log(206);;
show consensus logs;
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000035	744	206
xa commit 'xx';
# 92. crash_purge_non_critical_after_update_index
set @@debug='';
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000035	1131	206
binlog.000036	292	210
xa recover;
formatID	gtrid_length	bqual_length	data
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000035	1131	206
binlog.000036	6276	210
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
finish load
flush logs;
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000035	1131	206
binlog.000036	6320	210
binlog.000037	292	218
insert into db_crash_9.t2 values(1);
select @@debug;
@@debug

call dbms_consensus.purge_log(218);;
show consensus logs;
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
1	2	0	xx
show consensus logs;
Log_name	File_size	Start_log_index
binlog.000037	744	218
xa commit 'xx';
SET GLOBAL debug="";
drop table db_crash_9.t;
drop table db_crash_9.t2;
drop database db_crash_9;
