#
# Test recover xa specification.
#
source include/have_log_bin.inc;
--source include/have_binlog_format_row.inc
--source include/not_valgrind.inc
source include/have_debug.inc;
--source include/not_crashrep.inc

call mtr.add_suppression('Unsafe statement written .*');
call mtr.add_suppression('Found .*');

connection default;

create database db_crash_9;
create table db_crash_9.t(id int);
insert into db_crash_9.t values(0);

--let $iter=1
while ($iter <= 2)
{
	if ($iter == 1)
	{
	--let $sql=insert into db_crash_9.t values(1)
	}
	if ($iter == 2)
	{
	--let $sql=update db_crash_9.t set id = id+1
	}

	--echo # run cmd: $sql
	connect (conn1,localhost,root,,);
	connection conn1;
	xa recover;

	--echo # 0$iter. succ

	-- exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect

	--source suite/binlog_gtid/t/flush_and_load_data.inc

	SET GLOBAL debug="";
	disconnect conn1;
	--sleep 2
	connect (conn1,localhost,root,,);
	connection conn1;

	flush logs;
	show consensus logs;
	--eval $sql
	let $last_log_index= query_get_value(select LAST_LOG_INDEX from  information_schema.ALISQL_CLUSTER_LOCAL, LAST_LOG_INDEX, 1);
	--eval call dbms_consensus.purge_log($last_log_index);

	xa recover;
	show consensus logs;
	xa commit 'xx';

	--echo # 1$iter. crash_purge_before_update_index
	--exec echo "restart: --debug='+d,crash_purge_before_update_index'" > $mysqltest_vardir/tmp/mysqld.1.expect
	--source include/wait_until_connected_again.inc
	-- exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect

	disconnect conn1
	--sleep 2

	connect (conn1,localhost,root,,);
	connection conn1;
	--source suite/binlog_gtid/t/flush_and_load_data.inc

	flush logs;
	show consensus logs;
	--eval $sql
	let $last_log_index= query_get_value(select LAST_LOG_INDEX from  information_schema.ALISQL_CLUSTER_LOCAL, LAST_LOG_INDEX, 1);
	--eval call dbms_consensus.purge_log($last_log_index);
	--error 2013
	show consensus logs;

	--source include/wait_until_disconnected.inc
	--enable_reconnect
	--exec echo "restart" > $mysqltest_vardir/tmp/mysqld.1.expect
	--source include/wait_until_connected_again.inc
	--disable_reconnect

	connection conn1;
	xa recover;
	show consensus logs;
	xa commit 'xx';

	--echo # 2$iter. crash_purge_before_remove_logs_from_index
	--exec echo "restart: --debug='+d,crash_purge_before_remove_logs_from_index'" > $mysqltest_vardir/tmp/mysqld.1.expect
	--source include/wait_until_connected_again.inc
	-- exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect

	connect (conn1,localhost,root,,);
	connection conn1;
	--source suite/binlog_gtid/t/flush_and_load_data.inc

	flush logs;
	show consensus logs;
	--eval $sql
	let $last_log_index= query_get_value(select LAST_LOG_INDEX from  information_schema.ALISQL_CLUSTER_LOCAL, LAST_LOG_INDEX, 1);
	--eval call dbms_consensus.purge_log($last_log_index);
	--error 2013
	show consensus logs;

	--source include/wait_until_disconnected.inc
	--enable_reconnect
	--exec echo "restart" > $mysqltest_vardir/tmp/mysqld.1.expect
	--source include/wait_until_connected_again.inc
	--disable_reconnect

	connection conn1;
	xa recover;
	show consensus logs;
	xa commit 'xx';


	--echo # 3$iter. fault_injection_copy_part_file
	--exec echo "restart: --debug='+d,fault_injection_copy_part_file'" > $mysqltest_vardir/tmp/mysqld.1.expect
	--source include/wait_until_connected_again.inc
	-- exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect

	connect (conn1,localhost,root,,);
	connection conn1;
	--source suite/binlog_gtid/t/flush_and_load_data.inc

	flush logs;
	show consensus logs;
	--eval $sql
	let $last_log_index= query_get_value(select LAST_LOG_INDEX from  information_schema.ALISQL_CLUSTER_LOCAL, LAST_LOG_INDEX, 1);
	--eval call dbms_consensus.purge_log($last_log_index);
	--error 2013
	show consensus logs;

	--source include/wait_until_disconnected.inc
	--enable_reconnect
	--exec echo "restart" > $mysqltest_vardir/tmp/mysqld.1.expect
	--source include/wait_until_connected_again.inc
	--disable_reconnect

	connection conn1;
	xa recover;
	show consensus logs;
	xa commit 'xx';

--exit
	--echo # 4$iter. crash_create_before_rename_index_file
	-- exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect

	SET GLOBAL debug="+d,crash_create_before_rename_index_file";
	--source suite/binlog_gtid/t/flush_and_load_data.inc
	disconnect conn1;
	--sleep 2
	connect (conn1,localhost,root,,);
	connection conn1;


	flush logs;
	show consensus logs;
	--eval $sql
	let $last_log_index= query_get_value(select LAST_LOG_INDEX from  information_schema.ALISQL_CLUSTER_LOCAL, LAST_LOG_INDEX, 1);
	--eval call dbms_consensus.purge_log($last_log_index);
	--error 2013
	show consensus logs;

	--source include/wait_until_disconnected.inc
	--enable_reconnect
	--exec echo "restart" > $mysqltest_vardir/tmp/mysqld.1.expect
	--source include/wait_until_connected_again.inc
	--disable_reconnect

	connection conn1;
	xa recover;
	show consensus logs;
	xa commit 'xx';

	--echo # 5$iter. crash_create_after_rename_index_file
	-- exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect


	SET GLOBAL debug="+d,crash_create_after_rename_index_file";
	--source suite/binlog_gtid/t/flush_and_load_data.inc
	disconnect conn1;
	--sleep 2
	connect (conn1,localhost,root,,);
	connection conn1;


	flush logs;
	show consensus logs;
	--eval $sql
	let $last_log_index= query_get_value(select LAST_LOG_INDEX from  information_schema.ALISQL_CLUSTER_LOCAL, LAST_LOG_INDEX, 1);
	--eval call dbms_consensus.purge_log($last_log_index);
	--error 2013
	show consensus logs;

	--source include/wait_until_disconnected.inc
	--enable_reconnect
	--exec echo "restart" > $mysqltest_vardir/tmp/mysqld.1.expect
	--source include/wait_until_connected_again.inc
	--disable_reconnect

	connection conn1;
	xa recover;
	show consensus logs;
	xa commit 'xx';


	--echo # 6$iter. crash_purge_before_truncate_before
	-- exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect

	SET GLOBAL debug="+d,crash_purge_before_truncate_before";
	--source suite/binlog_gtid/t/flush_and_load_data.inc
	disconnect conn1;
	--sleep 2
	connect (conn1,localhost,root,,);
	connection conn1;


	flush logs;
	show consensus logs;
	--eval $sql
	let $last_log_index= query_get_value(select LAST_LOG_INDEX from  information_schema.ALISQL_CLUSTER_LOCAL, LAST_LOG_INDEX, 1);
	--eval call dbms_consensus.purge_log($last_log_index);
	--error 2013
	show consensus logs;

	--source include/wait_until_disconnected.inc
	--enable_reconnect
	--exec echo "restart" > $mysqltest_vardir/tmp/mysqld.1.expect
	--source include/wait_until_connected_again.inc
	--disable_reconnect

	connection conn1;
	xa recover;
	show consensus logs;
	xa commit 'xx';

	--echo # 7$iter. crash_purge_before_update_index_after_truncate
	-- exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect

	SET GLOBAL debug="+d,crash_purge_before_update_index_after_truncate";
	--source suite/binlog_gtid/t/flush_and_load_data.inc
	disconnect conn1;
	--sleep 2
	connect (conn1,localhost,root,,);
	connection conn1;


	flush logs;
	show consensus logs;
	--eval $sql
	let $last_log_index= query_get_value(select LAST_LOG_INDEX from  information_schema.ALISQL_CLUSTER_LOCAL, LAST_LOG_INDEX, 1);
	--eval call dbms_consensus.purge_log($last_log_index);
	--error 2013
	show consensus logs;

	--source include/wait_until_disconnected.inc
	--enable_reconnect
	--exec echo "restart" > $mysqltest_vardir/tmp/mysqld.1.expect
	--source include/wait_until_connected_again.inc
	--disable_reconnect

	connection conn1;
	xa recover;
	show consensus logs;
	xa commit 'xx';


	--echo # 8$iter. crash_purge_critical_after_update_index
	-- exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect

	SET GLOBAL debug="+d,crash_purge_critical_after_update_index";
	--source suite/binlog_gtid/t/flush_and_load_data.inc
	disconnect conn1;
	--sleep 2
	connect (conn1,localhost,root,,);
	connection conn1;


	flush logs;
	show consensus logs;
	--eval $sql
	let $last_log_index= query_get_value(select LAST_LOG_INDEX from  information_schema.ALISQL_CLUSTER_LOCAL, LAST_LOG_INDEX, 1);
	--eval call dbms_consensus.purge_log($last_log_index);
	--error 2013
	show consensus logs;


	--source include/wait_until_disconnected.inc
	--enable_reconnect
	--exec echo "restart" > $mysqltest_vardir/tmp/mysqld.1.expect
	--source include/wait_until_connected_again.inc
	--disable_reconnect

	connection conn1;
	xa recover;
	show consensus logs;
	xa commit 'xx';

	--echo # 9$iter. crash_purge_non_critical_after_update_index
	-- exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect

	--source suite/binlog_gtid/t/flush_and_load_data.inc

	SET GLOBAL debug="+d,crash_purge_non_critical_after_update_index";
	disconnect conn1;
	--sleep 2
	connect (conn1,localhost,root,,);
	connection conn1;


	flush logs;
	show consensus logs;
	--eval $sql
	let $last_log_index= query_get_value(select LAST_LOG_INDEX from  information_schema.ALISQL_CLUSTER_LOCAL, LAST_LOG_INDEX, 1);
	--eval call dbms_consensus.purge_log($last_log_index);
	--error 2013
	show consensus logs;


	--source include/wait_until_disconnected.inc
	--enable_reconnect
	--exec echo "restart" > $mysqltest_vardir/tmp/mysqld.1.expect
	--source include/wait_until_connected_again.inc
	--disable_reconnect

	connection conn1;
	xa recover;
	show consensus logs;
	xa commit 'xx';

	disconnect conn1;

	--inc $iter
}
connection default;
SET GLOBAL debug="";

drop table db_crash_9.t;
drop database db_crash_9;
