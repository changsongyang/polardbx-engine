call mtr.add_suppression('Unsafe statement written .*');
call mtr.add_suppression('Found .*');
SET @base_seq = (SELECT CAST(variable_value AS UNSIGNED) FROM performance_schema.global_status WHERE variable_name = 'Lizard_current_gcn');
create database db_tc;
create table db_tc.t(id int);
SET SESSION debug="+d,simulate_crash_when_sync_binlog";
begin;
insert into db_tc.t values(1);
commit;
ERROR HY000: Lost connection to MySQL server during query
select * from db_tc.t;
id
select * from db_tc.t;
id
1
SET SESSION debug="+d,simulate_crash_when_sync_binlog";
begin;
update db_tc.t set id = 2;
commit;
ERROR HY000: Lost connection to MySQL server during query
select * from db_tc.t;
id
1
select * from db_tc.t;
id
2
SET SESSION debug="+d,simulate_crash_when_sync_binlog";
xa start 'xx';
insert into db_tc.t values(1);
xa end 'xx';
xa prepare 'xx';
ERROR HY000: Lost connection to MySQL server during query
xa commit 'xx';
include/assert.inc [expect_gcn == actual_gcn]
include/assert.inc [expect_state == actual_state]
SET SESSION debug="+d,simulate_crash_when_sync_binlog";
xa start 'xx';
update db_tc.t set id = 2;
xa end 'xx';
xa prepare 'xx';
ERROR HY000: Lost connection to MySQL server during query
xa commit 'xx';
include/assert.inc [expect_gcn == actual_gcn]
include/assert.inc [expect_state == actual_state]
SET SESSION debug="+d,simulate_crash_when_sync_binlog";
xa start 'xx';
insert into db_tc.t values(1);
xa end 'xx';
xa commit 'xx' one phase;
ERROR HY000: Lost connection to MySQL server during query
include/assert.inc [expect_gcn == actual_gcn]
include/assert.inc [expect_state == actual_state]
SET SESSION debug="+d,simulate_crash_when_sync_binlog";
xa start 'xx';
update db_tc.t set id = 2;
xa end 'xx';
xa commit 'xx' one phase;
ERROR HY000: Lost connection to MySQL server during query
include/assert.inc [expect_gcn == actual_gcn]
include/assert.inc [expect_state == actual_state]
xa start 'xx';
insert into db_tc.t values(1);
xa end 'xx';
xa prepare 'xx';
SET SESSION debug="+d,simulate_crash_when_sync_binlog";
xa commit 'xx';
ERROR HY000: Lost connection to MySQL server during query
include/assert.inc [expect_gcn == actual_gcn]
include/assert.inc [expect_state == actual_state]
xa start 'xx';
update db_tc.t set id = 2;
xa end 'xx';
xa prepare 'xx';
SET SESSION debug="+d,simulate_crash_when_sync_binlog";
xa commit 'xx';
ERROR HY000: Lost connection to MySQL server during query
include/assert.inc [expect_gcn == actual_gcn]
include/assert.inc [expect_state == actual_state]
xa start 'xx';
insert into db_tc.t values(1);
xa end 'xx';
xa prepare 'xx';
SET SESSION debug="+d,simulate_crash_when_sync_binlog";
xa rollback 'xx';
ERROR HY000: Lost connection to MySQL server during query
include/assert.inc [expect_gcn == actual_gcn]
include/assert.inc [expect_state == actual_state]
xa start 'xx';
insert into db_tc.t values(1);
update db_tc.t set id = 2;
xa end 'xx';
xa prepare 'xx';
SET SESSION debug="+d,simulate_crash_when_sync_binlog";
xa rollback 'xx';
ERROR HY000: Lost connection to MySQL server during query
include/assert.inc [expect_gcn == actual_gcn]
include/assert.inc [expect_state == actual_state]
drop table db_tc.t;
drop database db_tc;
