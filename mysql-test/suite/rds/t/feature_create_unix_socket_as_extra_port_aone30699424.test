--source include/not_threadpool.inc

# 1.Test the max connection numbers
create database extra_socket_test;
use extra_socket_test;

SET GLOBAL max_connections=3;
SET GLOBAL max_user_connections=2;
SET GLOBAL max_unix_admin_connections=3;
create user 'test1'@'%';
create user 'test2'@'%';
disconnect default;

--let $ADMIN_SOCKET_DIR = $MYSQL_TMP_DIR/admin_mysqld.1.sock

--disable_query_log

# 1-1. The number of no/rmal TCP connections can not greater than max_connections + 1,
# the last connection is reserved for SUPER users. The number of normal TCP connections
# for each user can not greater than max_user_connections.

connect (con_norm0, localhost, test1,,);
connect (con_norm1, localhost, test1,,);

--error ER_TOO_MANY_USER_CONNECTIONS
connect (con_norm2, localhost, test1,,);

connect (con_norm3, localhost, test2,,);

--error ER_CON_COUNT_ERROR
connect (con_norm4, localhost, test2,,);

--sleep 1
connect (con_norm5, localhost, root,,);

--error ER_CON_COUNT_ERROR
connect (con_norm6, localhost, root,,);

# 1-2.The number of unix admin connections are not restricted by max_connections
# and max_user_connections, and can not greater than max_unix_admin_connections.

connect (conn_admin1, localhost, root,,,,$ADMIN_SOCKET_DIR);
connect (conn_admin2, localhost, root,,,,$ADMIN_SOCKET_DIR);
connect (conn_admin3, localhost, root,,,,$ADMIN_SOCKET_DIR);

--error ER_CON_COUNT_ERROR
connect (conn_admin4, localhost, root,,,,$ADMIN_SOCKET_DIR);

disconnect conn_admin3;
connect (conn_admin5, localhost, test1,,,,$ADMIN_SOCKET_DIR);

disconnect con_norm0;
disconnect con_norm1;
disconnect con_norm3;
disconnect con_norm5;

disconnect conn_admin1;
disconnect conn_admin2;
disconnect conn_admin5;

# 1-3.The number of unix admin connections should not be limited by maintain_max_connections.
connect (default, localhost, root,,);
SET GLOBAL maintain_max_connections= 1;
SET GLOBAL maintain_user_list = "root";
disconnect default;
connect (conn_maintain0, localhost, root,,);

# got error because exceed maintain_max_connections
--error ER_IA_TOO_MANY_CONNECTIONS
connect (conn_maintain1, localhost, root,,);

connect (conn_maintain2, localhost, root,,,,$ADMIN_SOCKET_DIR);
connect (conn_maintain3, localhost, root,,,,$ADMIN_SOCKET_DIR);
connect (conn_maintain4, localhost, root,,,,$ADMIN_SOCKET_DIR);

# got error because exceed max_unix_admin_connections
--error ER_CON_COUNT_ERROR
connect (conn_maintain5, localhost, root,,,,$ADMIN_SOCKET_DIR);

disconnect conn_maintain0;
disconnect conn_maintain2;
disconnect conn_maintain3;
disconnect conn_maintain4;
--enable_query_log

# 2.Test show the processlist for normal user and kill user.
connect (default, localhost, root,,);
SET GLOBAL max_unix_admin_connections=3;
grant select, process on *.* to 'test2'@'%';
grant select on *.* to 'test1'@'%';
SET GLOBAL rds_kill_user_list = "test2";

connect (con_close1, localhost, test1,,extra_socket_test,,$ADMIN_SOCKET_DIR);
--replace_column 1 # 5 # 6 # 7 # 8 #
show processlist;
--replace_column 1 # 5 # 6 # 7 # 8 #
select * from information_schema.processlist where DB = "extra_socket_test";

connect (con_close2, localhost, test2,,extra_socket_test,,$ADMIN_SOCKET_DIR);
--replace_column 1 # 5 # 6 # 7 # 8 #
show processlist;
--replace_column 1 # 5 # 6 # 7 # 8 #
select * from information_schema.processlist where DB = "extra_socket_test";

disconnect con_close1;
disconnect con_close2;
disconnect default;

# 3.Test the kill acl, kill user connected through unix test can kill connections.

connect (con_kill1, localhost, test1,,);
connect (con_kill2, localhost, test2,,);
connect (con_kill3, localhost, test1,,,,$ADMIN_SOCKET_DIR);

connect (con_kill4, localhost, root,,,,$ADMIN_SOCKET_DIR);
--replace_column 1 # 5 # 6 # 7 # 8 #
SELECT id INTO @id FROM information_schema.processlist WHERE user='test1' LIMIT 1;
kill @id;

--replace_column 1 # 5 # 6 # 7 # 8 #
SELECT id INTO @id FROM information_schema.processlist WHERE user='test1' LIMIT 1;
kill @id;

--replace_column 1 # 5 # 6 # 7 # 8 #
SELECT id INTO @id FROM information_schema.processlist WHERE user='test2' LIMIT 1;
kill @id;

disconnect con_kill4;

# 4.Test the priv of unix admin connection using data protect feature.
connect (default, localhost, root,,,,$ADMIN_SOCKET_DIR);
SET GLOBAL rds_data_protect_control= 'MAINTAIN';
SET GLOBAL rds_data_protect_level= 'ALL';
grant all on *.* to 'test1'@'%';
grant all on *.* to 'test2'@'%';
SET GLOBAL maintain_user_list = "root,test1";
CREATE DATABASE db_test1;
disconnect default;

connect (con_priv1, localhost, test2,,,,$ADMIN_SOCKET_DIR);
--error ER_RDS_DATA_PROTECTION
DROP DATABASE db_test1;

connect (con_priv2, localhost, test1,,,,$ADMIN_SOCKET_DIR);
DROP DATABASE db_test1;

disconnect con_priv1;
disconnect con_priv2;

# cleanup
connect (default, localhost, root,,);
SET GLOBAL max_connections= default;
SET GLOBAL max_user_connections= default;
SET GLOBAL opt_enable_rds_priv_strategy= default;
SET GLOBAL max_unix_admin_connections= default;
SET GLOBAL maintain_max_connections= default;
SET GLOBAL maintain_user_list= default;
SET GLOBAL rds_kill_user_list= default;
SET GLOBAL rds_data_protect_control= default;
SET GLOBAL rds_data_protect_level= default;

drop user test1;
drop user test2;

drop database extra_socket_test;
